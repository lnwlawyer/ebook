<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ระบบอ่านหนังสือออนไลน์</title>
    
    <!-- PWA / Web App Manifest & Meta Tags Start -->
    <!-- 1. ตั้งค่า Icon และ Theme Color สำหรับ Mobile -->
    <meta name="theme-color" content="#4ade80">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="หนังสือออนไลน์">
    
    <!-- 2. ตั้งค่าสำหรับ iOS (Safari) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="หนังสือออนไลน์">
    <link rel="apple-touch-icon" href="https://live.staticflickr.com/65535/54606972002_64bb13e1d2_w.jpg">

    <!-- 3. Web App Manifest (Embedded Data URI) -->
    <!-- กำหนดให้แอปเปิดแบบ Standalone (เต็มจอ), ใช้ไอคอนที่ระบุ, และชื่อแอป -->
    <link rel="manifest" href='data:application/manifest+json;charset=utf-8,{"name":"หนังสือออนไลน์","short_name":"หนังสือออนไลน์","start_url":".","display":"standalone","background_color":"#e8f5e9","theme_color":"#4ade80","description":"ระบบอ่านหนังสือออนไลน์","icons":[{"src":"https://live.staticflickr.com/65535/54606972002_64bb13e1d2_w.jpg","sizes":"192x192","type":"image/jpeg"},{"src":"https://live.staticflickr.com/65535/54606972002_64bb13e1d2_w.jpg","sizes":"512x512","type":"image/jpeg"}]}'>
    <!-- PWA End -->

    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Sarabun font for Thai readability -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 for beautiful alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #e8f5e9; /* Light green background */
            /* ป้องกันการเด้งของหน้าจอใน iOS */
            overscroll-behavior-y: none;
        }
        /* Hidden by default, activated by JS */
        .page {
            display: none;
        }
        /* Page currently visible */
        .active-page {
            display: block;
            flex-grow: 1; /* Key to making footer stick to bottom: expand content to fill space */
        }
        /* Styling for book covers on the home page */
        .book-cover {
            /* ลบ fixed height ออก เพื่อให้ควบคุมผ่าน Tailwind หรือ inline style ได้ยืดหยุ่นขึ้น */
            background-size: contain; /* เปลี่ยนเป็น contain เพื่อให้แสดงรูปเต็มไม่โดนตัด */
            background-repeat: no-repeat;
            background-position: center;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background-color: #f9fafb; /* เพิ่มสีพื้นหลังจางๆ กรณีรูปไม่เต็มกรอบ */
        }
        .book-cover:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        /* SweetAlert2 custom image styling */
        .swal2-book-cover {
            width: auto; /* ปรับเป็น auto เพื่อให้สัดส่วนถูกต้อง */
            max-width: 100%;
            max-height: 400px; /* จำกัดความสูงไม่ให้ล้นจอ */
            object-fit: contain; /* แสดงรูปเต็ม */
            border: 3px solid black;
            border-radius: 8px;
            margin: 0 auto;
            display: block;
        }
        /* PDF viewer iframe styling */
        .pdf-viewer {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 8px;
            background-color: #f0f0f0;
        }
        /* Responsive grid for recommended books */
        #recommendedBooks {
            display: grid; /* Use grid for layout */
            gap: 1.5rem; /* Gap between grid items */
            /* ใช้ auto-fill เพื่อให้คอลัมน์ถูกจองพื้นที่ไว้แม้ไม่มีเนื้อหา ทำให้ขนาดการ์ดไม่ยืดขยายจนเต็มจอ */
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
        }
    </style>
</head>
<!-- Added flex and flex-col to body to manage vertical layout -->
<body class="min-h-screen flex flex-col">
    <!-- Header Section -->
    <header class="bg-gradient-to-r from-green-400 to-green-600 text-white shadow-lg sticky top-0 z-50">
        <!-- เปลี่ยนจาก container mx-auto เป็น w-full เพื่อให้ขยายเต็มจอ และเพิ่ม padding ด้านข้าง -->
        <div class="w-full px-4 md:px-8 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <!-- Placeholder image for logo -->
                    <img src="https://live.staticflickr.com/65535/54721899593_5d789ef073_w.jpg" alt="โลโก้" class="h-16 w-16 md:h-20 md:w-20 object-cover rounded-full border-2 border-white">
                    <div>
                        <h1 class="text-xl md:text-3xl font-bold">หนังสือออนไลน์</h1>
                        <p id="dateTime" class="text-xs md:text-sm text-green-100"></p>
                    </div>
                </div>
                <div class="space-x-2">
                    <button onclick="showPage('booksPage')" class="bg-white text-green-700 px-3 py-1 md:px-4 md:py-2 rounded-lg hover:bg-gray-100 transition shadow-sm font-semibold text-sm md:text-base">ค้นหาหนังสือ</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Home Page -->
    <div id="homePage" class="page active-page">
        <!-- ลบ container เดิมออกเพื่อให้ Sidebar ชิดขอบ และใช้ flex layout แบบเต็มจอ -->
        <div class="flex flex-col md:flex-row min-h-screen items-stretch">
            
            <!-- Sidebar (Left Column) -->
            <!-- ปรับเป็น Sidebar เต็มความสูง สีพื้นหลังขาว ติดขอบซ้าย -->
            <aside class="w-full md:w-72 bg-white border-r border-gray-200 flex-shrink-0 z-40 relative">
                <div class="sticky top-28 p-6"> <!-- sticky top-28 เพื่อหลบ Header -->
                    <div class="flex items-center mb-6 border-b pb-4 border-gray-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
                        </svg>
                        <h3 class="font-bold text-lg text-gray-800">หมวดหมู่หนังสือ</h3>
                    </div>
                    <!-- Genre List Container -->
                    <div id="genreSidebar" class="flex flex-row md:flex-col overflow-x-auto md:overflow-visible gap-2 md:gap-1 pb-2 md:pb-0">
                        <!-- Buttons will be injected here by JS -->
                        <p class="text-gray-500 text-sm">กำลังโหลด...</p>
                    </div>
                </div>
            </aside>

            <!-- Main Content (Right Column) -->
            <main class="w-full flex-grow p-4 md:p-8 bg-[#e8f5e9]">
                <div class="bg-white rounded-xl shadow-md p-6 mb-8 min-h-[500px]">
                    <div class="flex justify-between items-center mb-6 border-b pb-4 border-gray-100">
                        <h2 class="text-2xl font-bold text-gray-800" id="categoryTitle">หนังสือทั้งหมด</h2>
                        <span id="bookCountBadge" class="bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">0 เล่ม</span>
                    </div>
                    
                    <div id="recommendedBooks" class="grid gap-6">
                        <!-- Book cards will be loaded here by JavaScript -->
                        <p class="text-center text-gray-500 col-span-full py-10" id="loadingMessage">กำลังโหลดหนังสือ...</p>
                    </div>
                </div>
            </main>

        </div>
    </div>

    <!-- Books List Page -->
    <div id="booksPage" class="page">
        <div class="container mx-auto px-4 py-8">
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">รายการหนังสือทั้งหมด</h2>
                    <div class="flex flex-col md:flex-row items-center gap-4 w-full md:w-auto">
                        <div class="relative w-full md:w-auto">
                            <input type="text" id="searchBook" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="ค้นหาหนังสือ...">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-2.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <button onclick="showPage('homePage')" class="w-full md:w-auto bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                            </svg>
                            กลับหน้าหลัก
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อหนังสือ</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">แนวหนังสือ</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ผู้แต่ง</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">การดำเนินการ</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="booksList">
                            <!-- Book list will be loaded here by JavaScript -->
                            <tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">กำลังโหลดหนังสือ...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Read Book Page -->
    <div id="readBookPage" class="page">
        <div class="container mx-auto px-4 py-8">
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800 truncate pr-4" id="bookTitle">ชื่อหนังสือ</h2>
                    <!-- เปลี่ยนจาก showPage('booksPage') เป็น showPage('homePage') และเปลี่ยนข้อความปุ่มเป็น กลับหน้าหลัก -->
                    <button onclick="showPage('homePage')" class="shrink-0 bg-gray-200 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-300 transition flex items-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        กลับหน้าหลัก
                    </button>
                </div>
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="md:w-1/4">
                        <div id="bookCover" class="w-full h-64 book-cover rounded-lg mb-4 mx-auto md:mx-0 max-w-[200px] md:max-w-full"></div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 mb-2">แนว: <span id="bookGenre" class="font-medium">แฟนตาซี</span></p>
                            <p class="text-sm text-gray-600 mb-2">ผู้แต่ง: <span id="bookAuthor" class="font-medium">ชื่อผู้แต่ง</span></p>
                            <p class="text-sm text-gray-600 mb-2">ยอดการกดดู: <span id="bookViewCount" class="font-medium">0</span> ครั้ง</p>
                        </div>
                    </div>
                    <div class="md:w-3/4">
                        <div id="bookContent" class="bg-gray-50 p-4 md:p-6 rounded-lg min-h-[400px]">
                            <iframe id="pdfViewer" class="pdf-viewer" src=""></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Section -->
    <footer class="bg-gray-800 text-white py-6 mt-auto z-50 relative">
        <div class="container mx-auto px-4">
            <div class="flex flex-col justify-center items-center text-center">
                <div>
                    <h3 class="text-xl font-bold">ระบบอ่านหนังสือออนไลน์</h3>
                    <p class="text-gray-400 text-sm mt-1">แหล่งรวมหนังสือคุณภาพสำหรับทุกคน</p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // *** ทดสอบการรัน JavaScript เบื้องต้น ***
        console.log("JavaScript เริ่มทำงานแล้ว!");

        // *** สำคัญมาก: แทนที่ด้วย URL ของ Google Apps Script Web App ของคุณ ***
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx8OHQXlFdvt-HbbZr2nARpPMePPoFdaHSnFQruCwK7NqMWpTXmHjnZpsvOoC5dyO_u/exec'; 

        let allBooks = []; // เก็บข้อมูลหนังสือทั้งหมด
        let currentGenre = 'ทั้งหมด'; // เก็บหมวดหมู่ที่เลือกปัจจุบัน

        // Function to update date and time
        function updateDateTime() {
            const now = new Date();
            const options = {
                year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                hour12: false, timeZone: 'Asia/Bangkok'
            };
            document.getElementById('dateTime').textContent = now.toLocaleString('th-TH', options);
        }
        setInterval(updateDateTime, 1000);
        updateDateTime(); 

        // Function to show a specific page
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active-page'));
            const pageElement = document.getElementById(pageId);
            if (pageElement) {
                pageElement.classList.add('active-page');
                window.scrollTo(0, 0); // Scroll to top when changing page
            }

            if (pageId === 'homePage') {
                // If returning to home, reload with current genre
                loadRecommendedBooks(currentGenre); 
            }
            if (pageId === 'booksPage') {
                renderBooksList('booksList', 'searchBook');
            }
        }

        // --- Function to fetch books ---
        async function fetchBooks() {
            const loadingMessageHome = document.getElementById('loadingMessage');
            const loadingMessageList = document.querySelector('#booksList td[colspan="4"]');
            
            if (loadingMessageHome) loadingMessageHome.textContent = 'กำลังโหลดหนังสือ...';
            if (loadingMessageList) loadingMessageList.textContent = 'กำลังโหลดหนังสือ...';

            if (!GOOGLE_APPS_SCRIPT_URL || GOOGLE_APPS_SCRIPT_URL.includes('YOUR_GOOGLE_APPS_SCRIPT')) {
                console.error('ERROR: URL not set.');
                return;
            }

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                allBooks = data;
                console.log('Books fetched:', allBooks);
                
                // หลังจากโหลดข้อมูลเสร็จ ให้สร้าง Sidebar และแสดงหนังสือ
                renderGenreSidebar();
                showPage('homePage');

            } catch (error) {
                console.error('Error fetching books:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'ข้อผิดพลาด',
                    text: 'ไม่สามารถโหลดข้อมูลได้: ' + error.message,
                    confirmButtonText: 'ตกลง'
                });
                allBooks = [];
            } finally {
                const loadingMsgHomeElement = document.getElementById('loadingMessage');
                if (loadingMsgHomeElement) loadingMsgHomeElement.remove();
                
                const loadingMsgListElement = document.querySelector('#booksList td[colspan="4"]');
                if (loadingMsgListElement) loadingMsgListElement.remove();
            }
        }

        // --- Function to generate Sidebar Genres ---
        function renderGenreSidebar() {
            const sidebar = document.getElementById('genreSidebar');
            if (!sidebar) return;
            sidebar.innerHTML = ''; // Clear loading text

            // 1. Extract unique genres
            const genres = [...new Set(allBooks.map(book => book.genre || 'อื่นๆ'))];
            genres.sort(); // Sort alphabetically
            
            // Add "All" option at the beginning
            genres.unshift('ทั้งหมด');

            // 2. Create buttons
            genres.forEach(genre => {
                const btn = document.createElement('button');
                btn.textContent = genre;
                btn.className = `text-left px-4 py-2 rounded-lg transition text-sm md:text-base whitespace-nowrap md:whitespace-normal w-auto md:w-full ${
                    genre === currentGenre 
                    ? 'bg-green-600 text-white font-bold shadow-md' 
                    : 'bg-gray-100 text-gray-700 hover:bg-green-100 hover:text-green-700'
                }`;
                
                btn.onclick = () => {
                    currentGenre = genre;
                    // Update active styling
                    Array.from(sidebar.children).forEach(child => {
                        child.className = 'text-left px-4 py-2 rounded-lg transition text-sm md:text-base whitespace-nowrap md:whitespace-normal w-auto md:w-full bg-gray-100 text-gray-700 hover:bg-green-100 hover:text-green-700';
                    });
                    btn.className = 'text-left px-4 py-2 rounded-lg transition text-sm md:text-base whitespace-nowrap md:whitespace-normal w-auto md:w-full bg-green-600 text-white font-bold shadow-md';
                    
                    loadRecommendedBooks(genre);
                };
                
                sidebar.appendChild(btn);
            });
        }

        // --- Update loadRecommendedBooks to accept filter ---
        function loadRecommendedBooks(genre = 'ทั้งหมด') {
            const container = document.getElementById('recommendedBooks');
            const titleElement = document.getElementById('categoryTitle');
            const badgeElement = document.getElementById('bookCountBadge');
            
            container.innerHTML = ''; // Clear existing

            // Update Header Title
            titleElement.textContent = genre === 'ทั้งหมด' ? 'หนังสือทั้งหมด' : `หมวดหมู่: ${genre}`;

            // Filter books
            let filteredBooks = allBooks;
            if (genre !== 'ทั้งหมด') {
                filteredBooks = allBooks.filter(book => (book.genre || 'อื่นๆ') === genre);
            }

            // Update Badge Count
            badgeElement.textContent = `${filteredBooks.length} เล่ม`;

            if (filteredBooks.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-10 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                        <p class="mt-2 text-gray-500">ไม่พบหนังสือในหมวดหมู่นี้</p>
                    </div>
                `;
                return;
            }

            // Render books
            filteredBooks.forEach(book => {
                const coverUrl = book.coverurl && book.coverurl.trim() ? book.coverurl : 'https://via.placeholder.com/150x220.png?text=ไม่มีปก';
                const div = document.createElement('div');
                div.className = 'bg-gray-50 rounded-lg p-4 hover:shadow-lg transition cursor-pointer border border-transparent hover:border-green-200 flex flex-col h-full';
                div.onclick = () => readBook(book.id);
                div.innerHTML = `
                    <div class="book-cover mb-3 rounded-md shadow-sm w-full" style="background-image: url('${coverUrl}'); height: 220px;"></div>
                    <div class="flex-grow">
                        <h3 class="font-bold text-lg text-gray-800 line-clamp-2 mb-1" title="${book.title}">${book.title || 'ไม่ระบุชื่อ'}</h3>
                        <p class="text-xs text-green-600 font-medium bg-green-50 inline-block px-2 py-1 rounded-full mb-2">${book.genre || 'ไม่ระบุ'}</p>
                        <div class="text-sm text-gray-600 flex items-center mb-1">
                            <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                            ${book.author || 'ไม่ระบุ'}
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200 flex justify-between items-center text-xs text-gray-500">
                        <span class="flex items-center">
                            <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                            ${book.viewcount || 0}
                        </span>
                        <span class="text-green-600 font-semibold group-hover:underline">อ่านเลย &rarr;</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Shows a SweetAlert popup with the book cover
        function showBookCover(book) {
            const coverUrl = book.coverurl && book.coverurl.trim() ? book.coverurl : 'https://via.placeholder.com/150x220.png?text=ไม่มีปก';
            Swal.fire({
                title: book.title || 'ไม่ระบุชื่อ',
                html: `<img src="${coverUrl}" class="swal2-book-cover" alt="ปกหนังสือ">`,
                confirmButtonText: 'ปิด',
                confirmButtonColor: '#3085d6',
                showCloseButton: true,
                width: '350px',
                padding: '1em',
                background: '#fff'
            });
        }

        // Renders the list of books in a table
        function renderBooksList(tableId, searchInputId) {
            const booksList = document.getElementById(tableId);
            booksList.innerHTML = ''; 
            
            if (!allBooks || allBooks.length === 0) {
                booksList.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500 italic">ไม่พบข้อมูลหนังสือในระบบ</td></tr>';
                return;
            }

            allBooks.forEach(book => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="h-10 w-10 rounded-md mr-3 bg-gray-200 flex-shrink-0 overflow-hidden">
                                <img src="${book.coverurl || 'https://via.placeholder.com/40'}" class="h-full w-full object-cover" onerror="this.src='https://via.placeholder.com/40'">
                            </div>
                            <div class="font-medium text-gray-900 cursor-pointer hover:text-green-600" onclick='showBookCover(${JSON.stringify(book)})'>${book.title || 'ไม่ระบุชื่อ'}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600"><span class="bg-gray-100 px-2 py-1 rounded-full text-xs">${book.genre || 'ไม่ระบุ'}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${book.author || 'ไม่ระบุ'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="readBook(${book.id})" class="text-white bg-green-600 hover:bg-green-700 px-3 py-1.5 rounded-md text-xs transition shadow-sm">อ่าน</button>
                    </td>
                `;
                booksList.appendChild(row);
            });

            const searchInput = document.getElementById(searchInputId);
            if (searchInput) {
                searchInput.addEventListener('input', e => {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    const filtered = allBooks.filter(book =>
                        (book.title || '').toLowerCase().includes(searchTerm) ||
                        (book.author || '').toLowerCase().includes(searchTerm) ||
                        (book.genre || '').toLowerCase().includes(searchTerm)
                    );
                    booksList.innerHTML = '';
                    if (filtered.length === 0) {
                        booksList.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500">ไม่พบหนังสือที่ตรงกับการค้นหา</td></tr>';
                        return;
                    }
                    filtered.forEach(book => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50 transition';
                        row.innerHTML = `
                             <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="h-10 w-10 rounded-md mr-3 bg-gray-200 flex-shrink-0 overflow-hidden">
                                        <img src="${book.coverurl || 'https://via.placeholder.com/40'}" class="h-full w-full object-cover" onerror="this.src='https://via.placeholder.com/40'">
                                    </div>
                                    <div class="font-medium text-gray-900 cursor-pointer hover:text-green-600" onclick='showBookCover(${JSON.stringify(book)})'>${book.title || 'ไม่ระบุชื่อ'}</div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600"><span class="bg-gray-100 px-2 py-1 rounded-full text-xs">${book.genre || 'ไม่ระบุ'}</span></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${book.author || 'ไม่ระบุ'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="readBook(${book.id})" class="text-white bg-green-600 hover:bg-green-700 px-3 py-1.5 rounded-md text-xs transition shadow-sm">อ่าน</button>
                            </td>
                        `;
                        booksList.appendChild(row);
                    });
                });
            }
        }

        // Function to display the selected book
        function readBook(bookId) {
            const book = allBooks.find(b => b.id === bookId);
            if (book) {
                if (typeof book.viewcount === 'number') book.viewcount++;
                else book.viewcount = 1;

                document.getElementById('bookTitle').textContent = book.title || 'ไม่ระบุชื่อ';
                document.getElementById('bookGenre').textContent = book.genre || 'ไม่ระบุ';
                document.getElementById('bookAuthor').textContent = book.author || 'ไม่ระบุ';
                document.getElementById('bookViewCount').textContent = book.viewcount;

                const coverUrl = book.coverurl && book.coverurl.trim() ? book.coverurl : 'https://via.placeholder.com/150x220.png?text=ไม่มีปก';
                document.getElementById('bookCover').style.backgroundImage = `url('${coverUrl}')`;

                const pdfUrl = book.pdfurl && book.pdfurl.trim() ? book.pdfurl.replace('/view', '/preview') : '';
                const pdfViewer = document.getElementById('pdfViewer');
                const bookContentDiv = document.getElementById('bookContent');

                if (pdfUrl) {
                    pdfViewer.src = pdfUrl;
                    if (!bookContentDiv.contains(pdfViewer)) {
                        bookContentDiv.innerHTML = ''; 
                        bookContentDiv.appendChild(pdfViewer);
                    }
                } else {
                    pdfViewer.src = ''; 
                    bookContentDiv.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-gray-500 py-20">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <p class="text-lg font-medium">ไม่พบไฟล์ PDF สำหรับหนังสือนี้</p>
                            <p class="text-sm">กรุณาติดต่อผู้ดูแลระบบ</p>
                        </div>
                    `;
                }
                showPage('readBookPage'); 
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'ข้อผิดพลาด',
                    text: 'ไม่พบข้อมูลหนังสือ'
                });
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await fetchBooks();
        });
    </script>
</body>
</html>
